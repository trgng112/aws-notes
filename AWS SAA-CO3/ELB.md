### Elastic Load Balancer
![[Pasted image 20250719202129.png]]

- Why use a load balancer
	- Spread load across multiple downstream instances
	- expose a single point of access (DNS) to app
	- handle failures of downstream services
	- health checks
	- provide SSL termination (HTTPS) for websites
	- enforce stickiness with cookies
	- high availability across zones
	- separate public from private traffic
	- is a managed load balancer
		- aws guarantees it will be working
		- aws take cares of upgrades, maintenance 
		- aws provides a few configs knobs
	- integrated with many AWS services
		- ec2,ecs
		- aws certificate manager, cloudwatch,
		- route 53, waf, global accelerator
	- Health checks
		- Enable the load balancer to know if the instance is available to reply to requests
		- crucial for load balancers
		- check by ports and routes (/health)
		- if the response is not 200, it is unhealthy
	- Types:
		- classic load balancer - CLB - deprecated
		- Application load balancer - ALB 
			- HTTPS,HTTPS,websocket
		- Network load Balancer - NLB
			- TCP TLS UDP
		- Gateway load balancer - GWLB
			- Operated at layer 3 - IP protocol
		- recommended to use the latest version
		- can be set up as internal (private) or external (public) ELBs


### Load balancer security groups
![[Pasted image 20250719232249.png]]

### Application Load balancer - ALB

- Layer 7 - HTTP
- Load balancing to multiple HTTP aplications across machines (target groups)
- load balancing to multiple applications on the same machine (containers)
- support for HTTP/2 and websocket
- support redirects (from HTTP to HTTPS for example)
- routing tables to different target groups
	- routing based on path in URL (example.com/users & example.com/posts)
	- routing based on hostname in URL (one.example.com & other.example.com)
	- routing based on Query string, header (example.com/users?id=123&order=false)
- Great fit for microservices and container based application (docker and amazon ecs)
- has a port mapping feature to redirect to a dynamic port in ECS
- in comparison, we'd need multiple CLB per app
- ![[Pasted image 20250719232654.png]]
- Target groups
	- EC2 instances (can be managed by an Auto Scaling Group) - HTTP
	- ECS tasks( managed by ECS itself) - HTTP
	- Lambda functions - HTTP request is translated into a JSON event
	- IP addresses - must be private IPs
	- ALB can route to multiple target groups
	- Health checks are at the target group level
- ![[Pasted image 20250719232847.png]]
- fixed hostname
- the application servers don't see the IP of the client directly (x the header `x-Forwarded-For)
- We can also get port `X-Forwarded-port` and proto `X-Forwarded-Proto`
- ![[Pasted image 20250719233015.png]]

### Network load balancer - NLB

- Layer4
- Allows:
	- Forward TCP & UDP traffic to your instances
	- Handle millions of request per seconds
	- ultra low latency
- NLB has one static IP per AZ, and supports assigning Elastic IP (helpful for whitelisting specific IP)
- NLB are used for extreme performance, TCP or UDP traffic
- not included in AWS free tier
- ![[Pasted image 20250719234827.png]]
- Target groups:
	- EC2 instances
	- IP addresses - must be private IPs
	- Application load balancer - ALB 
	- Health check support the TCP HTTP and HTTPS protocols
	- ![[Pasted image 20250719234906.png]]


### Gateway Load Balancer GWLB

- Deploy, scale, manage a fleet of 3rd party network virtual appliances in AWS
	- Firewalls, intrusion detection and prevention system, payload manipulation
- Layer 3(network layer) - IP packets
- combines the following functions
	- Transparent Network Gateway - single entry/exit for all traffic
	- Load balancer - distributes traffic to your virtual appliances
	- ![[Pasted image 20250720120936.png]]
- Uses the GENEVE protocol on port 6081
- Target groups
	- EC2 instances
	- Ip addresses - must be private IPs
	- ![[Pasted image 20250720121031.png]]


### Sticky sessions
- It is possible to implement stickiness so that the same client is always redirected to the same instance behine a load balancer
- Works for CLB, ALB, NLB
- cookie used for stickiness has a set expiration date
- use case: make sure the user doesn't lose his session data
- ![[Pasted image 20250720121154.png]]
- Cookie names
	- App-based cookies
		- Custom cookie
			- generated by the target
			- can include any custom attributes required by the applciation
			- cookie name must be specified individually for each target group
			- dont use `AWSALB`, `AWSALBAPP` or `AWSALBTG` (reserved for use by the ALB)
		- Application cookie
			- generated by the load balancer
			- cookie name is AWSALBAPP
	- Duration-based Cookies
		- Cookie generated by the load balancer
		- cookie name is `AWSALB` for ALB, `AWSELB` for CLB
- Cross zone load balancer
	- Each load balancer instance distributes evenly across all registered instances in all AZ
	- ![[Pasted image 20250720121901.png]]
	- Application load balancer
		- Enabled by default (can be disabled at the target group level)
		- no charges for infer AZ data
	- NLB and GLB
		- disabled by default
		- you pay charges for inter AZ data if enabled
	- CLB 
		- disabled by default
		- not charged for infer AZ data

#### SSL/TLS
- An SSL Certificate allows traffic between your clients and your load balacner to be encrypted in transit (in-flight encryption)
- SSL refers to **secure sockets layer,** used to encrypt connections
- TLS refers to Transport layer security- mainly used , people still refer as SSL
- Public SSL certs are issued by Certificate Authorities (CA)
- Comodo,Symantec,GoDaddy,GlobalSign,..
- has an set expiration date and can be renewed
- ![[Pasted image 20250720122428.png]]
- the LB uses and X.509 certs (SSL/TLS server cert)
- manage certs using ACM (AWS Certificate Manager)
- can create upload your own certs
- HTTPS listener:
	- must specify default cert
	- add additional list of certs to support multiple domains
	- clients can use SNI (**Server Name Indication**) to specify the hostname they reach
- SNI: Solves the problem of loading multiple SSL certs onto one web server
	- newer protocol, requires the client ot indicate the hostname of the target server in the initial SSL handshake
	- server will then find the correct cert, or return the defautl one
	- Only works for ALB & NLB, Cloudfront
	- ![[Pasted image 20250720122804.png]]
	- ALB and NLB can support multiple listeners with multiple SSL certs, uses SNI to make it works

#### Connection Draining
 - Feature naming
	 - Connection Draining - CLB
	 - Deregistration Delay  - ALB & NLB
 - Time to complete " in-flight requests" while the instance is de-registering or unhealthy
 - stops sending new requests to the EC2 instance which is de-registering
 - Between 1 to 3600 seconds (default 300 secs)
 - Can be disabled (set value to 0)
 - set a low value if your requests are short 
 - ![[Pasted image 20250720123211.png]]

#### Auto scaling group - ASG
- in real-life, the load on your websites and apps can change
- in the cloud, you can create and get rid of servers very quickly
- The goal of ASG is to
	- scale out (add ec2 instances) to match increase load
	- scale in (remove ec2 instances) to match a decrease load
	- ensure we have a minimum and a maximum number of ec2 instances running
	- automatically register new instances to a load balancer
	- re-create an ec2 instance in case a previous one is terminated (unhealthy)
- ASG are free
- ![[Pasted image 20250720123456.png]]
- ![[Pasted image 20250720123528.png]]
- A Launch template
- ![[Pasted image 20250720123624.png]]
- Possible to scale ASG based on Cloudwatch alarms
- alarms monitors a metric (such as Average CPU, or a custom metric)
- Metrics such as Average CPU are computed for the overall ASG instances
- Based on the alarm:
	- we can create scale out policy (increase)
	- we can create scale in policy (decrease)
	- ![[Pasted image 20250720123739.png]]
- Scaling policies
	- Dynamic Scaling
		- Target tracking scaling
			- Simple to set up
			- example: I want the average ASG CPU to stay at around 40%
		- Simple/ Step Scaling
			- when cloudwatch alarm is triggered (CPU >70%) add 2 units
			- when cloudwatch alarm is triggered (cpu <30%) remove 1
	- Scheduled scaling
		- Anticipate a scaling based on known usage patterns
		- Example: increase the min capacity to 10 at 5pm on Fridays
	- Predictive scaling: continuously forecast load and schedule scaling ahead
	- good metrics: CPU utilization, RequestCoundPerTarget, Average Network In/Out
- Scaling cooldown
	- After a scaling activity happens, you are in the cooldown period (300 secs)
	- ASG will not launch or terminal additional instances (metrics to stabilize)
	-  advice: use a ready-to-use AMI to reduce configs time in order to be serving request fasters and reduce the cooldown period
	- 